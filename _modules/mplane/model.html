<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mplane.model &mdash; mPlane Protocol RI 0.9.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="mPlane Protocol RI 0.9.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../index.html">
          <span>mPlane Protocol RI 0.9.0 documentation</span></a></h1>
        <h2 class="heading"><span>mplane.model</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for mplane.model</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c"># mPlane Protocol Reference Implementation</span>
<span class="c"># Information Model and Element Registry</span>
<span class="c">#</span>
<span class="c"># (c) 2013-2014 mPlane Consortium (http://www.ict-mplane.eu)</span>
<span class="c">#               Author: Brian Trammell &lt;brian@trammell.ch&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify it under</span>
<span class="c"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c"># Software Foundation, either version 3 of the License, or (at your option) any</span>
<span class="c"># later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c"># FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more</span>
<span class="c"># details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License along with</span>
<span class="c"># this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Information model and element registry for the mPlane protocol.</span>

<span class="sd">This module implements Statements and Notifications, the core</span>
<span class="sd">messages used by the mPlane protocol, the Elements these</span>
<span class="sd">use to describe measurement and query schemas, and various</span>
<span class="sd">other classes to support them.</span>

<span class="sd">There are three kinds of Statement:</span>

<span class="sd">    - Capability represents something a component can do</span>
<span class="sd">    - Specification tells a component to do something it</span>
<span class="sd">      advertised a Capability for </span>
<span class="sd">    - Result returns the results for a Specification in-band</span>

<span class="sd">Notifications are used to transfer other information between</span>
<span class="sd">components and clients. There are four kinds of Notification:</span>

<span class="sd">    - Receipt notifies that a Result is not yet ready or</span>
<span class="sd">      that the results of an operation will be indirectly exported.</span>
<span class="sd">    - Redemption is a subsequent attempt to redeem a Receipt.</span>
<span class="sd">    - Withdrawal notifies that a Capability is no longer available.</span>
<span class="sd">    - Interrupt notifies that a running Specification should be stopped.</span>

<span class="sd">To see how all this fits together, let&#39;s simulate the message exchange</span>
<span class="sd">in a simple ping measurement. First, we load the registry and </span>
<span class="sd">programatically create a new Capability, as would be advertised by</span>
<span class="sd">the component. First, we initialize the registry and create a new </span>
<span class="sd">empty Capability.</span>

<span class="sd">&gt;&gt;&gt; import mplane</span>
<span class="sd">&gt;&gt;&gt; import json</span>
<span class="sd">&gt;&gt;&gt; mplane.model.initialize_registry()</span>
<span class="sd">&gt;&gt;&gt; cap = mplane.model.Capability()</span>

<span class="sd">First we set a temporal scope for the capability. Probe components </span>
<span class="sd">generally advertise a temporal scope from the present stretching </span>
<span class="sd">into the indeterminate future. In this case, we advertise that the </span>
<span class="sd">measurement performed is periodic, by setting the minimum period </span>
<span class="sd">supported by the capability: one ping per second.</span>

<span class="sd">&gt;&gt;&gt; cap.set_when(&quot;now ... future / 1s&quot;)</span>

<span class="sd">We can only ping from one IPv4 address, to any IPv4 address. </span>
<span class="sd">Adding a parameter without a constraint makes it unconstrained:</span>

<span class="sd">&gt;&gt;&gt; cap.add_parameter(&quot;source.ip4&quot;, &quot;10.0.27.2&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_parameter(&quot;destination.ip4&quot;)</span>

<span class="sd">Then we define the result columns this measurement can produce. Here,</span>
<span class="sd">we want quick reporting of min, max, and mean delays, as well as a</span>
<span class="sd">total count of singleton measurements taken and packets lost:</span>

<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.min&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.max&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.mean&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;delay.twoway.icmp.us.count&quot;)</span>
<span class="sd">&gt;&gt;&gt; cap.add_result_column(&quot;packets.lost&quot;)</span>

<span class="sd">Now we have a capability we could transform into JSON and make </span>
<span class="sd">available to clients via the mPlane protocol, or via static </span>
<span class="sd">download or configuration:</span>

<span class="sd">&gt;&gt;&gt; capjson = mplane.model.unparse_json(cap)</span>
<span class="sd">&gt;&gt;&gt; capjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;capability&quot;: &quot;measure&quot;, </span>
<span class="sd">  &quot;when&quot;: &quot;now ... future / 1s&quot;, </span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;, </span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;*&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.count&quot;, </span>
<span class="sd">              &quot;packets.lost&quot;]}&#39;</span>

<span class="sd">On the client side, we&#39;d receive this capability as a JSON object and turn it</span>
<span class="sd">into a capability, from which we generate a specification:</span>

<span class="sd">&gt;&gt;&gt; clicap = mplane.model.parse_json(capjson)</span>
<span class="sd">&gt;&gt;&gt; spec = mplane.model.Specification(capability=clicap)</span>
<span class="sd">&gt;&gt;&gt; spec</span>
<span class="sd">&lt;specification: measure when now ... future / 1s token 48d7393c schema 21e2a15a p(v)/m/r 2(0)/0/5&gt;</span>

<span class="sd">Here we have a specification with a given token, schema, and 2 parameters, </span>
<span class="sd">no metadata, and five result columns.</span>

<span class="sd">.. note:: The schema of the statement is identified by a</span>
<span class="sd">          schema hash, the first eight hex digits of which are shown for </span>
<span class="sd">          diagnostic purposes. Statements with identical sets of parameters </span>
<span class="sd">          and columns (schemas) will have identical schema hashes. Likewise,</span>
<span class="sd">          the token is defined by the schema as well as the parameter values.</span>

<span class="sd">First let&#39;s fill in a specific temporal scope for the measurement:</span>

<span class="sd">&gt;&gt;&gt; spec.set_when(&quot;2014-12-24 22:18:42 + 1m / 1s&quot;)</span>

<span class="sd">And then let&#39;s fill in some parameters. First, we can fill in all parameters whose</span>
<span class="sd">single values are already given by their constraints (in this case, source.ip4)</span>

<span class="sd">&gt;&gt;&gt; spec.set_single_values()</span>

<span class="sd">Then let&#39;s set a destination. Note that strings are accepted and</span>
<span class="sd">automatically parsed using each parameter&#39;s primitive type:</span>

<span class="sd">&gt;&gt;&gt; spec.set_parameter_value(&quot;destination.ip4&quot;, &quot;10.0.37.2&quot;)</span>

<span class="sd">And now we can transform this specification and send it back to</span>
<span class="sd">the component from which we got the capability:</span>

<span class="sd">&gt;&gt;&gt; specjson = mplane.model.unparse_json(spec)</span>
<span class="sd">&gt;&gt;&gt; specjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;specification&quot;: &quot;measure&quot;, </span>
<span class="sd">  &quot;token&quot;: &quot;ea839b56bc3f6004e95d780d7a64d899&quot;, </span>
<span class="sd">  &quot;when&quot;: &quot;2014-12-24 22:18:42.000000 + 1m / 1s&quot;, </span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;, </span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;10.0.37.2&quot;}, </span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.count&quot;, </span>
<span class="sd">              &quot;packets.lost&quot;]}&#39;</span>

<span class="sd">On the component side, likewise, we&#39;d receive this specification as a JSON</span>
<span class="sd">object and turn it back into a specification:</span>

<span class="sd">&gt;&gt;&gt; comspec = mplane.model.parse_json(specjson)</span>

<span class="sd">The component would determine the measurement, query, or other operation to</span>
<span class="sd">run by the specification, then extract the necessary parameter values, e.g.:</span>

<span class="sd">&gt;&gt;&gt; comspec.get_parameter_value(&quot;destination.ip4&quot;)</span>
<span class="sd">IPv4Address(&#39;10.0.37.2&#39;)</span>
<span class="sd">&gt;&gt;&gt; comspec.when().period()</span>
<span class="sd">datetime.timedelta(0, 1)</span>

<span class="sd">After running the measurement, the component would return the results</span>
<span class="sd">by assigning values to parameters which changed and result columns</span>
<span class="sd">measured:</span>

<span class="sd">&gt;&gt;&gt; res = mplane.model.Result(specification=comspec)</span>
<span class="sd">&gt;&gt;&gt; res.set_when(&quot;2014-12-24 22:18:42.993000 ... 2014-12-24 22:19:42.991000&quot;)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.min&quot;, 33155)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.mean&quot;, 55166)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.max&quot;, 192307)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;delay.twoway.icmp.us.count&quot;, 58220)</span>
<span class="sd">&gt;&gt;&gt; res.set_result_value(&quot;packets.lost&quot;, 2)</span>

<span class="sd">The result can then be serialized and sent back to the client:</span>

<span class="sd">&gt;&gt;&gt; resjson = json.dumps(res.to_dict())</span>
<span class="sd">&gt;&gt;&gt; resjson # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;result&quot;: &quot;measure&quot;, </span>
<span class="sd">  &quot;token&quot;: &quot;ea839b56bc3f6004e95d780d7a64d899&quot;, </span>
<span class="sd">  &quot;when&quot;: &quot;2014-12-24 22:18:42.993000 ... 2014-12-24 22:19:42.991000&quot;, </span>
<span class="sd">  &quot;parameters&quot;: {&quot;source.ip4&quot;: &quot;10.0.27.2&quot;, </span>
<span class="sd">                 &quot;destination.ip4&quot;: &quot;10.0.37.2&quot;},</span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.count&quot;, </span>
<span class="sd">              &quot;packets.lost&quot;],  </span>
<span class="sd">  &quot;resultvalues&quot;: [[&quot;33155&quot;, &quot;192307&quot;, &quot;55166&quot;, &quot;58220&quot;, &quot;2&quot;]]}&#39;</span>

<span class="sd">which can transform them back to a result and extract the values:</span>

<span class="sd">&gt;&gt;&gt; clires = mplane.model.message_from_dict(json.loads(resjson))</span>
<span class="sd">&gt;&gt;&gt; clires</span>
<span class="sd">&lt;result: measure when 2014-12-24 22:18:42.993000 ... 2014-12-24 22:19:42.991000 token 48d7393c schema 21e2a15a p/m/r(r) 2/0/5(1)&gt;</span>

<span class="sd">If the component cannot return results immediately (for example, because</span>
<span class="sd">the measurement will take some time), it can return a receipt instead:</span>

<span class="sd">&gt;&gt;&gt; rcpt = mplane.model.Receipt(specification=comspec)</span>

<span class="sd">This receipt contains all the information in the specification, as well as a token</span>
<span class="sd">which can be used to quickly identify it in the future. </span>

<span class="sd">&gt;&gt;&gt; rcpt.get_token()</span>
<span class="sd">&#39;48d7393c75aec14043c3a5af4f461013&#39;</span>

<span class="sd">.. note:: The mPlane protocol specification allows components to assign tokens</span>
<span class="sd">          however they like. In the reference implementation, the default token</span>
<span class="sd">          is based on a hash like the schema hash: statements with the same verb,</span>
<span class="sd">          schema, parameter values, and metadata will have identical default tokens.</span>
<span class="sd">          A component could, however, assign serial-number based tokens, or tokens</span>
<span class="sd">          mapping to structures in its own filesystem, etc.</span>

<span class="sd">&gt;&gt;&gt; jsonrcpt = json.dumps(rcpt.to_dict())</span>
<span class="sd">&gt;&gt;&gt; jsonrcpt # doctest: +SKIP</span>
<span class="sd">&#39;{&quot;receipt&quot;: &quot;measure&quot;,</span>
<span class="sd">  &quot;token&quot;: &quot;48d7393c75aec14043c3a5af4f461013&quot;, </span>
<span class="sd">  &quot;when&quot;: &quot;2014-12-24 22:18:42.000000 + 1m / 1s&quot;, </span>
<span class="sd">  &quot;parameters&quot;: {&quot;destination.ip4&quot;: &quot;10.0.37.2&quot;, </span>
<span class="sd">                 &quot;source.ip4&quot;: &quot;10.0.27.2&quot;}, </span>
<span class="sd">  &quot;results&quot;: [&quot;delay.twoway.icmp.us.min&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.max&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.mean&quot;, </span>
<span class="sd">              &quot;delay.twoway.icmp.us.count&quot;, </span>
<span class="sd">              &quot;packets.lost&quot;],}&#39;</span>

<span class="sd">The component keeps the receipt, keyed by token, and returns it to the</span>
<span class="sd">client in a message. The client then which generates a future redemption </span>
<span class="sd">referring to this receipt to retrieve the results:</span>

<span class="sd">&gt;&gt;&gt; clircpt = mplane.model.message_from_dict(json.loads(jsonrcpt))</span>
<span class="sd">&gt;&gt;&gt; clircpt</span>
<span class="sd">&lt;receipt: 48d7393c75aec14043c3a5af4f461013&gt;</span>
<span class="sd">&gt;&gt;&gt; rdpt = mplane.model.Redemption(receipt=clircpt)</span>
<span class="sd">&gt;&gt;&gt; rdpt</span>
<span class="sd">&lt;redemption: 48d7393c75aec14043c3a5af4f461013&gt;</span>

<span class="sd">Note here that the redemption has the same token as the receipt; </span>
<span class="sd">just the token may be sent back to the component to retrieve the </span>
<span class="sd">results:</span>

<span class="sd">&gt;&gt;&gt; json.dumps(rdpt.to_dict(token_only=True))</span>
<span class="sd">&#39;{&quot;redemption&quot;: &quot;measure&quot;, &quot;token&quot;: &quot;48d7393c75aec14043c3a5af4f461013&quot;}&#39;</span>

<span class="sd">.. note:: We should document and test interrupts and withdrawals, as well.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">ip_address</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c">#######################################################################</span>
<span class="c"># String constants</span>
<span class="c">#######################################################################</span>

<span class="n">ELEMENT_SEP</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>

<span class="n">RANGE_SEP</span> <span class="o">=</span> <span class="s">&quot; ... &quot;</span>
<span class="n">DURATION_SEP</span> <span class="o">=</span> <span class="s">&quot; + &quot;</span>
<span class="n">PERIOD_SEP</span> <span class="o">=</span> <span class="s">&quot; / &quot;</span>
<span class="n">SET_SEP</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span>

<span class="n">CONSTRAINT_ALL</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="n">VALUE_NONE</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>

<span class="n">TIME_PAST</span> <span class="o">=</span> <span class="s">&quot;past&quot;</span>
<span class="n">TIME_NOW</span> <span class="o">=</span> <span class="s">&quot;now&quot;</span>
<span class="n">TIME_FUTURE</span> <span class="o">=</span> <span class="s">&quot;future&quot;</span>

<span class="n">VERB_MEASURE</span> <span class="o">=</span> <span class="s">&quot;measure&quot;</span>
<span class="n">VERB_QUERY</span> <span class="o">=</span> <span class="s">&quot;query&quot;</span>
<span class="n">VERB_COLLECT</span> <span class="o">=</span> <span class="s">&quot;collect&quot;</span>
<span class="n">VERB_STORE</span> <span class="o">=</span> <span class="s">&quot;store&quot;</span>

<span class="n">KEY_PARAMETERS</span> <span class="o">=</span> <span class="s">&quot;parameters&quot;</span>
<span class="n">KEY_METADATA</span> <span class="o">=</span> <span class="s">&quot;metadata&quot;</span>
<span class="n">KEY_RESULTS</span> <span class="o">=</span> <span class="s">&quot;results&quot;</span>
<span class="n">KEY_RESULTVALUES</span> <span class="o">=</span> <span class="s">&quot;resultvalues&quot;</span>
<span class="n">KEY_TOKEN</span> <span class="o">=</span> <span class="s">&quot;token&quot;</span>
<span class="n">KEY_MESSAGE</span> <span class="o">=</span> <span class="s">&quot;message&quot;</span>
<span class="n">KEY_LINK</span> <span class="o">=</span> <span class="s">&quot;link&quot;</span>
<span class="n">KEY_WHEN</span> <span class="o">=</span> <span class="s">&quot;when&quot;</span>
<span class="n">KEY_SCHEDULE</span> <span class="o">=</span> <span class="s">&quot;schedule&quot;</span>
<span class="n">KEY_REGISTRY</span> <span class="o">=</span> <span class="s">&quot;registry&quot;</span>
<span class="n">KEY_LABEL</span> <span class="o">=</span> <span class="s">&quot;label&quot;</span>

<span class="n">KEY_MONTHS</span> <span class="o">=</span> <span class="s">&quot;months&quot;</span>
<span class="n">KEY_DAYS</span> <span class="o">=</span> <span class="s">&quot;days&quot;</span>
<span class="n">KEY_WEEKDAYS</span> <span class="o">=</span> <span class="s">&quot;weekdays&quot;</span>
<span class="n">KEY_HOURS</span> <span class="o">=</span> <span class="s">&quot;hours&quot;</span>
<span class="n">KEY_MINUTES</span> <span class="o">=</span> <span class="s">&quot;minutes&quot;</span>
<span class="n">KEY_SECONDS</span> <span class="o">=</span> <span class="s">&quot;seconds&quot;</span>

<span class="n">KIND_CAPABILITY</span> <span class="o">=</span> <span class="s">&quot;capability&quot;</span>
<span class="n">KIND_SPECIFICATION</span> <span class="o">=</span> <span class="s">&quot;specification&quot;</span>
<span class="n">KIND_RESULT</span> <span class="o">=</span> <span class="s">&quot;result&quot;</span>
<span class="n">KIND_RECEIPT</span> <span class="o">=</span> <span class="s">&quot;receipt&quot;</span>
<span class="n">KIND_REDEMPTION</span> <span class="o">=</span> <span class="s">&quot;redemption&quot;</span>
<span class="n">KIND_INDIRECTION</span> <span class="o">=</span> <span class="s">&quot;indirection&quot;</span>
<span class="n">KIND_WITHDRAWAL</span> <span class="o">=</span> <span class="s">&quot;withdrawal&quot;</span>
<span class="n">KIND_INTERRUPT</span> <span class="o">=</span> <span class="s">&quot;interrupt&quot;</span>
<span class="n">KIND_EXCEPTION</span> <span class="o">=</span> <span class="s">&quot;exception&quot;</span>

<span class="n">PARAM_START</span> <span class="o">=</span> <span class="s">&quot;start&quot;</span>
<span class="n">PARAM_END</span> <span class="o">=</span> <span class="s">&quot;end&quot;</span>

<span class="c"># Hash length in __repr__ strings</span>
<span class="n">REPHL</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c">#######################################################################</span>
<span class="c"># Universal parse and unparse functions for times and durations</span>
<span class="c">#######################################################################</span>

<span class="n">_iso8601_pat</span> <span class="o">=</span> <span class="s">&#39;(\d+-\d+-\d+)(\s+\d+:\d+(:\d+)?)?(\.\d+)?&#39;</span>
<span class="n">_iso8601_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_iso8601_pat</span><span class="p">)</span>
<span class="n">_iso8601_fmt</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;us&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.</span><span class="si">%f</span><span class="s">&#39;</span><span class="p">,</span>
                  <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">,</span>
                  <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&#39;</span><span class="p">,</span>
                  <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">}</span>

<span class="n">_dur_pat</span> <span class="o">=</span> <span class="s">&#39;((\d+)d)?((\d+)h)?((\d+)m)?((\d+)s)?&#39;</span>
<span class="n">_dur_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">_dur_pat</span><span class="p">)</span>
<span class="n">_dur_seclabel</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="mi">86400</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">),</span>
                  <span class="p">(</span> <span class="mi">3600</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">),</span>
                  <span class="p">(</span>   <span class="mi">60</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">),</span>
                  <span class="p">(</span>    <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_time</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_PAST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_past</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_FUTURE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_future</span>
    <span class="k">elif</span> <span class="n">valstr</span> <span class="o">==</span> <span class="n">TIME_NOW</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">time_now</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_iso8601_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">mstr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mg</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="c"># FIXME handle fractional seconds correctly</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S.</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mstr</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane timestamp&quot;</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">unparse_time</span><span class="p">(</span><span class="n">valts</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="s">&quot;us&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valts</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">valts</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">_iso8601_fmt</span><span class="p">[</span><span class="n">precision</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">valts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_dur</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_dur_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">valsec</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">valsec</span> <span class="o">+=</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">mg</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">valsec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; does not appear to be an mPlane duration&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unparse_dur</span><span class="p">(</span><span class="n">valtd</span><span class="p">):</span>
    <span class="n">valsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valtd</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
    <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">valsec</span> <span class="o">&gt;=</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">valunit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">valsec</span> <span class="o">/</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">valstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">valunit</span><span class="p">)</span> <span class="o">+</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">valsec</span> <span class="o">-=</span> <span class="n">valunit</span> <span class="o">*</span> <span class="n">_dur_seclabel</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;0s&quot;</span>
    <span class="k">return</span> <span class="n">valstr</span>

<span class="c">#######################################################################</span>
<span class="c"># Temporal Scoping and Scheduling</span>
<span class="c">#######################################################################</span>

<div class="viewcode-block" id="PastTime"><a class="viewcode-back" href="../../index.html#mplane.model.PastTime">[docs]</a><span class="k">class</span> <span class="nc">PastTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the indeterminate past. </span>
<span class="sd">    Do not instantiate; use the time_past instance of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_PAST</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.tscope.time_past&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<span class="n">time_past</span> <span class="o">=</span> <span class="n">PastTime</span><span class="p">()</span>

<div class="viewcode-block" id="NowTime"><a class="viewcode-back" href="../../index.html#mplane.model.NowTime">[docs]</a><span class="k">class</span> <span class="nc">NowTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the present.</span>
<span class="sd">    Do not instantiate; use the time_now instance of this class.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_NOW</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.tscope.time_now&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<span class="n">time_now</span> <span class="o">=</span> <span class="n">NowTime</span><span class="p">()</span>

<div class="viewcode-block" id="FutureTime"><a class="viewcode-back" href="../../index.html#mplane.model.FutureTime">[docs]</a><span class="k">class</span> <span class="nc">FutureTime</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the indeterminate future.</span>
<span class="sd">    Do not instantiate; use the time_future instance of this class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TIME_FUTURE</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.tscope.time_future&quot;</span>

    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ign</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<span class="n">time_future</span> <span class="o">=</span> <span class="n">FutureTime</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_parse_numset</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_unparse_numset</span><span class="p">(</span><span class="n">valset</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">valset</span><span class="p">))))</span>

<span class="n">_dow_label</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;mo&#39;</span><span class="p">,</span> <span class="s">&#39;tu&#39;</span><span class="p">,</span> <span class="s">&#39;we&#39;</span><span class="p">,</span> <span class="s">&#39;th&#39;</span><span class="p">,</span> <span class="s">&#39;fr&#39;</span><span class="p">,</span> <span class="s">&#39;sa&#39;</span><span class="p">,</span> <span class="s">&#39;so&#39;</span><span class="p">)</span>
<span class="n">_dow_number</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_dow_label</span><span class="p">)</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">_parse_wdayset</span><span class="p">(</span><span class="n">valstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">_dow_number</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_unparse_wdayset</span><span class="p">(</span><span class="n">valset</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_dow_label</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">valset</span><span class="p">))))</span>

<div class="viewcode-block" id="When"><a class="viewcode-back" href="../../index.html#mplane.model.When">[docs]</a><span class="k">class</span> <span class="nc">When</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the temporal scopes for capabilities, results, or </span>
<span class="sd">    single measurement specifications.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">valstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="p">):</span>
        <span class="c"># First separate the period from the value and parse it</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">PERIOD_SEP</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">perstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">perstr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_p</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># then try to split duration or range</span>
        <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DURATION_SEP</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">valstr</span><span class="p">,</span> <span class="n">durstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">valsplit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="n">parse_dur</span><span class="p">(</span><span class="n">durstr</span><span class="p">)</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="p">[</span><span class="n">valstr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">valsplit</span> <span class="o">=</span> <span class="n">valstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valsplit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valsplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">valstr</span> <span class="o">=</span> <span class="n">unparse_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">RANGE_SEP</span><span class="p">,</span> <span class="n">unparse_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">DURATION_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">valstr</span><span class="p">,</span> <span class="n">PERIOD_SEP</span><span class="p">,</span> <span class="n">unparse_dur</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_p</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">valstr</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;When: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

<div class="viewcode-block" id="When.is_immediate"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_immediate">[docs]</a>    <span class="k">def</span> <span class="nf">is_immediate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this is an immediate scope (i.e., starts now)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span>
</div>
<div class="viewcode-block" id="When.is_forever"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_forever">[docs]</a>    <span class="k">def</span> <span class="nf">is_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this scope ends in the indeterminate future&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_past"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_past">[docs]</a>    <span class="k">def</span> <span class="nf">is_past</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this is an indefinite past scope&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_now</span>
</div>
<div class="viewcode-block" id="When.is_future"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_future">[docs]</a>    <span class="k">def</span> <span class="nf">is_future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this is an indefinite future scope&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_infinite"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_infinite">[docs]</a>    <span class="k">def</span> <span class="nf">is_infinite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if this scope is completely infinite </span>
<span class="sd">        (from the infinite past to the infinite future)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span>
</div>
<div class="viewcode-block" id="When.is_definite"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_definite">[docs]</a>    <span class="k">def</span> <span class="nf">is_definite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if this scope defines a definite time </span>
<span class="sd">        or a definite time interval.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="When.is_singleton"><a class="viewcode-back" href="../../index.html#mplane.model.When.is_singleton">[docs]</a>    <span class="k">def</span> <span class="nf">is_singleton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if this temporal scope refers to a</span>
<span class="sd">        singleton measurement. Used in scheduling an enclosing</span>
<span class="sd">        Specification; has no meaning for Capabilities </span>
<span class="sd">        or Results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">is</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_datetimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">tzero</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_past</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<div class="viewcode-block" id="When.duration"><a class="viewcode-back" href="../../index.html#mplane.model.When.duration">[docs]</a>    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the duration of this temporal scope as a timedelta.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">timedelta</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</div>
    <span class="k">def</span> <span class="nf">period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p</span>

<div class="viewcode-block" id="When.timer_delays"><a class="viewcode-back" href="../../index.html#mplane.model.When.timer_delays">[docs]</a>    <span class="k">def</span> <span class="nf">timer_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple with delays for timers to signal the start and end of</span>
<span class="sd">        a temporal scope, given a specified time zero, which defaults to the</span>
<span class="sd">        current system time. </span>

<span class="sd">        The start delay is defined to be zero if the scheduled start time has</span>
<span class="sd">        already passed or the temporal scope is immediate (i.e., starts now).</span>
<span class="sd">        The start delay is None if the temporal scope has expired (that is,</span>
<span class="sd">        the current time is after the calculated end time)</span>

<span class="sd">        The end delay is defined to be None if the temporal scope has already</span>
<span class="sd">        expired, or if the temporal scope has no scheduled end (is infinite or</span>
<span class="sd">        a singleton). End delays are calculated to give priority to duration </span>
<span class="sd">        when a temporal scope is expressed in terms of duration, and to </span>
<span class="sd">        prioritize end time otherwise.</span>
<span class="sd"> </span>
<span class="sd">        Used in scheduling an enclosing Specification for execution. </span>
<span class="sd">        Has no meaning for Capabilities or Results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># default to current time</span>
        <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        
        <span class="c"># get datetimes</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">tzero</span><span class="p">)</span>

        <span class="c"># determine start delay, account for late start</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">tzero</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># determine end delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">time_future</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">tzero</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">();</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># detect expired temporal scope</span>
        <span class="k">if</span> <span class="n">ed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ed</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="When.sort_scope"><a class="viewcode-back" href="../../index.html#mplane.model.When.sort_scope">[docs]</a>    <span class="k">def</span> <span class="nf">sort_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return &lt; 0 if time t falls before this scope,</span>
<span class="sd">        0 if time t falls within the scope, </span>
<span class="sd">        or &gt; 0 if time t falls after this scope. </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Special handling for &quot;now&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a</span> <span class="ow">is</span> <span class="n">time_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="ow">is</span> <span class="n">time_now</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tzero</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">tzero</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">tzero</span>

        <span class="c"># Get concrete time range</span>
        <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">tzero</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="When.in_scope"><a class="viewcode-back" href="../../index.html#mplane.model.When.in_scope">[docs]</a>    <span class="k">def</span> <span class="nf">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if time t falls within this scope.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tzero</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="When.follows"><a class="viewcode-back" href="../../index.html#mplane.model.When.follows">[docs]</a>    <span class="k">def</span> <span class="nf">follows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if this scope follows (is contained by) another.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_a</span><span class="p">,</span> <span class="n">tzero</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">,</span> <span class="n">tzero</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div></div>
<span class="n">when_infinite</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">time_past</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">time_future</span><span class="p">)</span>

<div class="viewcode-block" id="Schedule"><a class="viewcode-back" href="../../index.html#mplane.model.Schedule">[docs]</a><span class="k">class</span> <span class="nc">Schedule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a schedule for repeated operations based on crontab-like</span>
<span class="sd">    sets of months, days, days of weeks, hours, minutes, and seconds.</span>
<span class="sd">    Used to specify repetitions of single measurements in a Specification.</span>
<span class="sd">    Designed to be broadly compatible with LMAP calendar-based scheduling.</span>

<span class="sd">    This class is not yet fully implemented or integrated into the</span>
<span class="sd">    information model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">when</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_months</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_days</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="s">&quot;&lt;Schedule &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">+=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
        <span class="n">rs</span> <span class="o">+=</span> <span class="s">&quot;cron &quot;</span>
        <span class="n">rs</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">),</span>
                                 <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">)]))</span>
        <span class="n">rs</span> <span class="o">+=</span> <span class="s">&quot;&gt;&quot;</span>
        <span class="k">return</span> <span class="n">rs</span>

<div class="viewcode-block" id="Schedule.to_dict"><a class="viewcode-back" href="../../index.html#mplane.model.Schedule.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents this schedule as a dictionary (for serialization).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_MONTHS</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_DAYS</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_WEEKDAYS</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_wdayset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_HOURS</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_MINUTES</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_SECONDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unparse_numset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
</div>
    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">KEY_WHEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">valstr</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_MONTHS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_months</span> <span class="o">=</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_MONTHS</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_DAYS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_days</span> <span class="o">=</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_DAYS</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_WEEKDAYS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span> <span class="o">=</span> <span class="n">_parse_wdayset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_WEEKDAYS</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_HOURS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_HOURS</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_MINUTES</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_MINUTES</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">KEY_SECONDS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="n">_parse_numset</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_SECONDS</span><span class="p">])</span>

<div class="viewcode-block" id="Schedule.datetime_iterator"><a class="viewcode-back" href="../../index.html#mplane.model.Schedule.datetime_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">datetime_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over datetimes generated by the schedule </span>
<span class="sd">        and period. </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># default to now, zero microseconds, initialize minus one second</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># get base period (default 1s) and</span>
        <span class="n">period</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">period</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># fast forward if necessary</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lag</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="n">lag</span><span class="p">)</span>

        <span class="c"># loop through time by period and check for match</span>
        <span class="n">t</span> <span class="o">-=</span> <span class="n">period</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">period</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">second</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">day</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_days</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weekdays</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">month</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_months</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">t</span>
</div></div>
<div class="viewcode-block" id="test_tscope"><a class="viewcode-back" href="../../index.html#mplane.model.test_tscope">[docs]</a><span class="k">def</span> <span class="nf">test_tscope</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test When&quot;&quot;&quot;</span>
    <span class="c"># Definite scope</span>
    <span class="n">wdef</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:00:00 ... 2009-02-20 15:00:00&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7200</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wdef</span><span class="o">.</span><span class="n">is_infinite</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:15:16&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wdef</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-21 14:15:16&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-01-20 22:30:15&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">sort_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2010-07-27 22:30:15&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:00:00&quot;</span><span class="p">),</span> 
                                 <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 15:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">10800</span><span class="p">)</span>

    <span class="c"># Immediate scope with period</span>
    <span class="n">wrel</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="s">&quot;now + 30m / 15s&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1800</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="o">==</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">wrel</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()</span> 
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">is_immediate</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:44:45&quot;</span><span class="p">),</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="p">(</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">),</span> <span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 14:00:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">wdef</span><span class="p">,</span> <span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 13:30:00&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">timer_delays</span><span class="p">(</span><span class="n">tzero</span><span class="o">=</span><span class="n">parse_time</span><span class="p">(</span><span class="s">&quot;2009-02-20 12:00:00&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1800</span><span class="p">)</span>

    <span class="c"># Infinite scope</span>
    <span class="k">assert</span> <span class="n">when_infinite</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">when_infinite</span><span class="o">.</span><span class="n">period</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">wdef</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">when_infinite</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wrel</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">when_infinite</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">when_infinite</span><span class="o">.</span><span class="n">_datetimes</span><span class="p">())</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<span class="c">#######################################################################</span>
<span class="c"># Primitive Types</span>
<span class="c">#######################################################################</span>
</div>
<div class="viewcode-block" id="Primitive"><a class="viewcode-back" href="../../index.html#mplane.model.Primitive">[docs]</a><span class="k">class</span> <span class="nc">Primitive</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a primitive mPlane data type. Primitive types define</span>
<span class="sd">    textual and native representations for data elements, and convert</span>
<span class="sd">    between the two.</span>

<span class="sd">    In general, client code will not need to interact with Primitives;</span>
<span class="sd">    conversion between strings and values is handled automatically by</span>
<span class="sd">    the Statement and Notification classes.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;&lt;special mplane primitive &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

<div class="viewcode-block" id="Primitive.parse"><a class="viewcode-back" href="../../index.html#mplane.model.Primitive.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a string to a value; default implementation</span>
<span class="sd">        returns the string directly, returning None for the</span>
<span class="sd">        special string &quot;*&quot;, which represents &quot;all values&quot; in </span>
<span class="sd">        mPlane.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sval</span>
</div>
<div class="viewcode-block" id="Primitive.unparse"><a class="viewcode-back" href="../../index.html#mplane.model.Primitive.unparse">[docs]</a>    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a value to a string; default implementation</span>
<span class="sd">        uses native __str__ representation, replaces None with a</span>
<span class="sd">        the special string &quot;*&quot;, representing all values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">VALUE_NONE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="StringPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.StringPrimitive">[docs]</a><span class="k">class</span> <span class="nc">StringPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a string. Uses the default implementation.</span>
<span class="sd">    If necessary, use the prim_string instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;string&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_string&quot;</span>
</div>
<div class="viewcode-block" id="NaturalPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.NaturalPrimitive">[docs]</a><span class="k">class</span> <span class="nc">NaturalPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a natural number (unsigned integer).</span>

<span class="sd">    Uses a Python int as the native representation.</span>
<span class="sd">    If necessary, use the prim_natural instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;natural&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_natural&quot;</span>

<div class="viewcode-block" id="NaturalPrimitive.parse"><a class="viewcode-back" href="../../index.html#mplane.model.NaturalPrimitive.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a natural value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="RealPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.RealPrimitive">[docs]</a><span class="k">class</span> <span class="nc">RealPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a real number (floating point).</span>

<span class="sd">    Uses a Python float as the native representation.</span>
<span class="sd">    If necessary, use the prim_real instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;real&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_real&quot;</span>

<div class="viewcode-block" id="RealPrimitive.parse"><a class="viewcode-back" href="../../index.html#mplane.model.RealPrimitive.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a floating point value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BooleanPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.BooleanPrimitive">[docs]</a><span class="k">class</span> <span class="nc">BooleanPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Represents a real number (floating point).</span>

<span class="sd">    Uses a Python bool as the native representation.</span>
<span class="sd">    If necessary, use the prim_boolean instance of this class;</span>
<span class="sd">    in general, however, this is used internally by Element.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;boolean&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_boolean&quot;</span>
    
<div class="viewcode-block" id="BooleanPrimitive.parse"><a class="viewcode-back" href="../../index.html#mplane.model.BooleanPrimitive.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to a boolean value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;True&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">sval</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid boolean value &quot;</span><span class="o">+</span><span class="n">sval</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="AddressPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.AddressPrimitive">[docs]</a><span class="k">class</span> <span class="nc">AddressPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a IPv4 or IPv6 host or network address.</span>

<span class="sd">    Uses the Python standard library ipaddress module</span>
<span class="sd">    for the native representation. </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_address&quot;</span>

<div class="viewcode-block" id="AddressPrimitive.parse"><a class="viewcode-back" href="../../index.html#mplane.model.AddressPrimitive.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a string to an address value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">VALUE_NONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="URLPrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.URLPrimitive">[docs]</a><span class="k">class</span> <span class="nc">URLPrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a URL. For now, URLs are implemented only as strings,</span>
<span class="sd">    without any parsing or validation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_url&quot;</span>
</div>
<div class="viewcode-block" id="TimePrimitive"><a class="viewcode-back" href="../../index.html#mplane.model.TimePrimitive">[docs]</a><span class="k">class</span> <span class="nc">TimePrimitive</span><span class="p">(</span><span class="n">Primitive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a UTC timestamp with arbitrary precision.</span>
<span class="sd">    Also handles special-purpose mPlane timestamps.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                
        <span class="k">return</span> <span class="s">&quot;mplane.model.prim_time&quot;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valstr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parse_time</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unparse_time</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<span class="n">prim_string</span> <span class="o">=</span> <span class="n">StringPrimitive</span><span class="p">()</span>
<span class="n">prim_natural</span> <span class="o">=</span> <span class="n">NaturalPrimitive</span><span class="p">()</span>
<span class="n">prim_real</span> <span class="o">=</span> <span class="n">RealPrimitive</span><span class="p">()</span>
<span class="n">prim_boolean</span> <span class="o">=</span> <span class="n">BooleanPrimitive</span><span class="p">()</span>
<span class="n">prim_time</span> <span class="o">=</span> <span class="n">TimePrimitive</span><span class="p">()</span>
<span class="n">prim_address</span> <span class="o">=</span> <span class="n">AddressPrimitive</span><span class="p">()</span>
<span class="n">prim_url</span> <span class="o">=</span> <span class="n">URLPrimitive</span><span class="p">()</span>

<span class="n">_prim</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">prim_string</span><span class="p">,</span> 
                             <span class="n">prim_natural</span><span class="p">,</span> 
                             <span class="n">prim_real</span><span class="p">,</span> 
                             <span class="n">prim_boolean</span><span class="p">,</span>
                             <span class="n">prim_time</span><span class="p">,</span>
                             <span class="n">prim_address</span><span class="p">,</span> 
                             <span class="n">prim_url</span><span class="p">]}</span>

<div class="viewcode-block" id="test_primitives"><a class="viewcode-back" href="../../index.html#mplane.model.test_primitives">[docs]</a><span class="k">def</span> <span class="nf">test_primitives</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test primitive parsing and unparsing&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;foo&#39;</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;foo&#39;</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="n">prim_string</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span>
    <span class="k">assert</span> <span class="n">prim_natural</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;42&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="n">prim_natural</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;27&#39;</span>
    <span class="k">assert</span> <span class="n">prim_real</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;3.141592653589793&#39;</span>
    <span class="k">assert</span> <span class="n">prim_real</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;4.2e6&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mf">4200000.0</span>
    <span class="k">assert</span> <span class="n">prim_boolean</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;False&#39;</span>
    <span class="k">assert</span> <span class="n">prim_boolean</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;True&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;10.0.27.101&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.27.101&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&quot;10.0.27.101&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;10.0.27.101&#39;</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;2001:db8:1:33::c0:ffee&quot;</span><span class="p">)</span> <span class="o">==</span> \
           <span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;2001:db8:1:33::c0:ffee&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_address</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&quot;2001:db8:1:33::c0:ffee&quot;</span><span class="p">))</span> <span class="o">==</span> \
           <span class="s">&#39;2001:db8:1:33::c0:ffee&#39;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;2013-07-30 23:19:42&quot;</span><span class="p">)</span> <span class="o">==</span> \
           <span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">42</span><span class="p">))</span> <span class="o">==</span> \
           <span class="s">&#39;2013-07-30 23:19:42.000000&#39;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;now&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_now</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;past&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_past</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&quot;future&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="n">time_future</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_now</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;now&quot;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_past</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;past&quot;</span>
    <span class="k">assert</span> <span class="n">prim_time</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">time_future</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;future&quot;</span>

<span class="c">#######################################################################</span>
<span class="c"># Element classes</span>
<span class="c">#######################################################################</span>
</div>
<div class="viewcode-block" id="Element"><a class="viewcode-back" href="../../index.html#mplane.model.Element">[docs]</a><span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Element represents a name for a particular type of data with </span>
<span class="sd">    a specific semantic meaning; it is analogous to an IPFIX Information </span>
<span class="sd">    Element, or a named column in a relational database.</span>

<span class="sd">    An Element has a Name by which it can be compared to other Elements,</span>
<span class="sd">    and a primitive type, which it uses to convert values to and from</span>
<span class="sd">    strings.</span>

<span class="sd">    The mPlane reference implementation includes a default registry of</span>
<span class="sd">    elements; use initialize_registry() to use these.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span> <span class="o">=</span> <span class="n">prim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Element &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &gt;&quot;</span>

<div class="viewcode-block" id="Element.parse"><a class="viewcode-back" href="../../index.html#mplane.model.Element.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a string to a value for this Element; delegates to primitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Element.unparse"><a class="viewcode-back" href="../../index.html#mplane.model.Element.unparse">[docs]</a>    <span class="k">def</span> <span class="nf">unparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a value to a string for this Element; delegates to primitive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Element.compatible_with"><a class="viewcode-back" href="../../index.html#mplane.model.Element.compatible_with">[docs]</a>    <span class="k">def</span> <span class="nf">compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine based on naming rules if this element is compatible with</span>
<span class="sd">        element rval; that is, if transformation_to will return a function</span>
<span class="sd">        for turning a value of this element to the other. Compatibility based</span>
<span class="sd">        on name structure is a future feature; this method currently checks for</span>
<span class="sd">        name equality only.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">rval</span><span class="o">.</span><span class="n">_name</span>
</div>
<div class="viewcode-block" id="Element.transformation_to"><a class="viewcode-back" href="../../index.html#mplane.model.Element.transformation_to">[docs]</a>    <span class="k">def</span> <span class="nf">transformation_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a function which will transform values of this element</span>
<span class="sd">        into values of element rval; used to support unit conversions.</span>
<span class="sd">        This is a future feature, and is currently a no-op. </span>
<span class="sd">        Only valid if compatible_with returns True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
</div></div>
<span class="n">_typedef_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^([a-zA-Z0-9\.\_]+)\s*\:\s*(\S+)&#39;</span><span class="p">)</span>
<span class="n">_desc_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^\s+([^#]+)&#39;</span><span class="p">)</span>
<span class="n">_comment_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^\s*\#&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_element</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_typedef_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">_prim</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">_parse_elements</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an iterator over lines from a file or stream describing</span>
<span class="sd">    a set of Elements, returns a list of Elements. This file should </span>
<span class="sd">    contain element names and primitive names separated by &quot;:&quot; in the </span>
<span class="sd">    leftmost column, followed by zero or more indented lines of </span>
<span class="sd">    description. Used to initialize the mPlane element registry from a file;</span>
<span class="sd">    call initialize_registry instead</span>
<span class="sd">       </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">desclines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">_typedef_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">desclines</span><span class="p">):</span>
                <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desclines</span><span class="p">)</span>
                <span class="n">desclines</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">_prim</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">_desc_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">desclines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">desclines</span><span class="p">):</span>
        <span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desclines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elements</span>

<span class="n">_element_registry</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="initialize_registry"><a class="viewcode-back" href="../../index.html#mplane.model.initialize_registry">[docs]</a><span class="k">def</span> <span class="nf">initialize_registry</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the mPlane registry from a file; if no filename is given,</span>
<span class="sd">    initializes the registry from the internal set of Elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_element_registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;registry.txt&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">_parse_elements</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
            <span class="n">_element_registry</span><span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>
</div>
<span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_element_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="c">#######################################################################</span>
<span class="c"># Constraints</span>
<span class="c">#######################################################################</span>

<div class="viewcode-block" id="Constraint"><a class="viewcode-back" href="../../index.html#mplane.model.Constraint">[docs]</a><span class="k">class</span> <span class="nc">Constraint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a set of acceptable values for an element.</span>
<span class="sd">    The default constraint accepts everything; use</span>
<span class="sd">    the special instance constraint_all for this.</span>

<span class="sd">    Clients and components will generally interact with the </span>
<span class="sd">    Constraint classes through Parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span> <span class="o">=</span> <span class="n">prim</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Represent this Constraint as a string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CONSTRAINT_ALL</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.constraint_all&quot;</span>

<div class="viewcode-block" id="Constraint.met_by"><a class="viewcode-back" href="../../index.html#mplane.model.Constraint.met_by">[docs]</a>    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine if this constraint is met by a given value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Constraint.single_value"><a class="viewcode-back" href="../../index.html#mplane.model.Constraint.single_value">[docs]</a>    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this constraint only allows a single value, return it. </span>
<span class="sd">        Otherwise, return None. The default constraint allows all values,</span>
<span class="sd">        so this always returns None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>
</div></div>
<span class="n">constraint_all</span> <span class="o">=</span> <span class="n">Constraint</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<div class="viewcode-block" id="RangeConstraint"><a class="viewcode-back" href="../../index.html#mplane.model.RangeConstraint">[docs]</a><span class="k">class</span> <span class="nc">RangeConstraint</span><span class="p">(</span><span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents acceptable values for an element as an inclusive range&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">astr</span><span class="p">,</span> <span class="n">bstr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">astr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">bstr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="s">&quot;RangeConstraint needs either a string &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;or an explicit range&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">):</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> \
               <span class="n">RANGE_SEP</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.RangeConstraint(&quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
                                             <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

<div class="viewcode-block" id="RangeConstraint.met_by"><a class="viewcode-back" href="../../index.html#mplane.model.RangeConstraint.met_by">[docs]</a>    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine if the value is within the range&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RangeConstraint.single_value"><a class="viewcode-back" href="../../index.html#mplane.model.RangeConstraint.single_value">[docs]</a>    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this constraint only allows a single value, return it. Otherwise, return None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="SetConstraint"><a class="viewcode-back" href="../../index.html#mplane.model.SetConstraint">[docs]</a><span class="k">class</span> <span class="nc">SetConstraint</span><span class="p">(</span><span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents acceptable values as a discrete set.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">,</span> <span class="n">sval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SET_SEP</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">vs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SET_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;mplane.model.SetConstraint(&quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
                                             <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

<div class="viewcode-block" id="SetConstraint.met_by"><a class="viewcode-back" href="../../index.html#mplane.model.SetConstraint.met_by">[docs]</a>    <span class="k">def</span> <span class="nf">met_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine if the value is a mamber of the set&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vs</span>
</div>
<div class="viewcode-block" id="SetConstraint.single_value"><a class="viewcode-back" href="../../index.html#mplane.model.SetConstraint.single_value">[docs]</a>    <span class="k">def</span> <span class="nf">single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If this constraint only allows a single value, return it. Otherwise, return None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="parse_constraint"><a class="viewcode-back" href="../../index.html#mplane.model.parse_constraint">[docs]</a><span class="k">def</span> <span class="nf">parse_constraint</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a primitive and a string value, parse a constraint </span>
<span class="sd">    string (returned via str(constraint)) into an instance of an </span>
<span class="sd">    appropriate Constraint class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sval</span> <span class="o">==</span> <span class="n">CONSTRAINT_ALL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">constraint_all</span>
    <span class="k">elif</span> <span class="n">sval</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RANGE_SEP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RangeConstraint</span><span class="p">(</span><span class="n">prim</span><span class="o">=</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="n">sval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SetConstraint</span><span class="p">(</span><span class="n">prim</span><span class="o">=</span><span class="n">prim</span><span class="p">,</span> <span class="n">sval</span><span class="o">=</span><span class="n">sval</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="test_constraints"><a class="viewcode-back" href="../../index.html#mplane.model.test_constraints">[docs]</a><span class="k">def</span> <span class="nf">test_constraints</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test range and set constraints&quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">constraint_all</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="s">&quot;whatever&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">constraint_all</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">prim_natural</span><span class="p">,</span><span class="s">&quot;0 ... 99&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">rc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;0 ... 99&quot;</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">prim_address</span><span class="p">,</span><span class="s">&quot;10.0.27.100,10.0.28.103&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.28.103&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">ip_address</span><span class="p">(</span><span class="s">&#39;10.0.27.103&#39;</span><span class="p">))</span>

<span class="c">#######################################################################</span>
<span class="c"># Statements</span>
<span class="c">#######################################################################</span>
</div>
<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Parameter is an element which can take a constraint and a value. </span>
<span class="sd">    In Capabilities, Parameters have constraints and no value; in</span>
<span class="sd">    Specifications and Results, Parameters have both constraints and</span>
<span class="sd">    values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraint_all</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">constraint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Parameter &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; value &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

<div class="viewcode-block" id="Parameter.has_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.has_value">[docs]</a>    <span class="k">def</span> <span class="nf">has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this component has a value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Parameter.set_single_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.set_single_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_single_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If this Parameter&#39;s Constraint allows only a single value, and this</span>
<span class="sd">        Paramater does not yet have a value, set the value to the only one</span>
<span class="sd">        allowed by the Constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_value</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">single_value</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Parameter.set_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value of the Parameter. </span>
<span class="sd">        Either takes a value of the correct type for the associated Primitive, or </span>
<span class="sd">        a string, which will be parsed to a value of the correct type.</span>

<span class="sd">        Raises ValueError if the value is not allowable for the Constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="o">.</span><span class="n">met_by</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; cannot take value &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Parameter.get_value"><a class="viewcode-back" href="../../index.html#mplane.model.Parameter.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return this Parameter&#39;s value&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span>
</div>
    <span class="k">def</span> <span class="nf">_as_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_clear_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraint</span> <span class="o">=</span> <span class="n">constraint_all</span>
</div>
<div class="viewcode-block" id="Metavalue"><a class="viewcode-back" href="../../index.html#mplane.model.Metavalue">[docs]</a><span class="k">class</span> <span class="nc">Metavalue</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Metavalue is an element which can take an unconstrained value.</span>
<span class="sd">    Metavalues are used in statement metadata sections.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Metavalue &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; value &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &gt;&quot;</span>

    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instanceof</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span>

    <span class="k">def</span> <span class="nf">_as_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ResultColumn"><a class="viewcode-back" href="../../index.html#mplane.model.ResultColumn">[docs]</a><span class="k">class</span> <span class="nc">ResultColumn</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ResultColumn is an element which can take an array of values. </span>
<span class="sd">    In Capabilities and Specifications, this array is empty, while in</span>
<span class="sd">    Results it has one or more values, such that all the ResultColumns</span>
<span class="sd">    in the Result have the same number of values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_element</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent_element</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_element</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ResultColumn &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">+</span><span class="s">&quot; values&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c"># Automatically parse strings</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c"># Automatically extend column to fit</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

        <span class="c"># Append or replace value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement"><a class="viewcode-back" href="../../index.html#mplane.model.Statement">[docs]</a><span class="k">class</span> <span class="nc">Statement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Statement is an assertion about the properties of a measurement</span>
<span class="sd">    or other action performed by an mPlane component. This class </span>
<span class="sd">    contains common implementation for the three kinds of mPlane</span>
<span class="sd">    statement. Clients and components should use the</span>
<span class="sd">    :class:`mplane.model.Capability`, :class:`mplane.model.Specification`, </span>
<span class="sd">    and :class:`mplane.model.Result` classes instead.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Member variables</span>
    <span class="n">_params</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_metadata</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_resultcolumns</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_link</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_verb</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_when</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_token</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_schedule</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># completely ignored unless this is a specification</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c"># Make a blank statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Fill in from dictionary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Fill in from defaults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>
            <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">when</span> <span class="o">=</span> <span class="n">when_infinite</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>           
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">when</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_verb</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_repr</span><span class="p">()</span><span class="o">+</span>\
               <span class="s">&quot; when &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span><span class="o">+</span>\
               <span class="s">&quot; token &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="n">REPHL</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; schema &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">(</span><span class="n">REPHL</span><span class="p">)</span><span class="o">+</span>\
               <span class="bp">self</span><span class="o">.</span><span class="n">_more_repr</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_label_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot; (&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw Statement&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw Statement&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Statement.add_parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraint_all</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically add a parameter to this statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">),</span> 
                                  <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span>
                                  <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.has_parameter"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.has_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">has_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the statement has a parameter with the given name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
</div>
<div class="viewcode-block" id="Statement.parameter_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.parameter_names">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the names of parameters in this Statement&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.count_parameters"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">count_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of parameters in this Statement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.count_parameter_values"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_parameter_values">[docs]</a>    <span class="k">def</span> <span class="nf">count_parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of parameters with values in this Statement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Statement.get_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value for a named parameter on this Statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.set_parameter_value"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically set a value for a parameter on this Statement.&quot;&quot;&quot;</span>
        <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span>
        <span class="n">elem</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.add_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically add a metadata element to this statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metavalue</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.has_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.has_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">has_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the statement has a metadata element with the given name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
</div>
<div class="viewcode-block" id="Statement.metadata_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.metadata_names">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the names of metadata elements in this Statement&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.count_metadata"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">count_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of metavalues in this Statement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.add_result_column"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.add_result_column">[docs]</a>    <span class="k">def</span> <span class="nf">add_result_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Programatically add a result column to this Statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">elem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResultColumn</span><span class="p">(</span><span class="n">element</span><span class="p">(</span><span class="n">elem_name</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">has_result_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">elem_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span>

<div class="viewcode-block" id="Statement.result_column_names"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.result_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">result_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over the names of result columns in this statement&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Statement.count_result_columns"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_result_columns">[docs]</a>    <span class="k">def</span> <span class="nf">count_result_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of result columns in this Statement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.count_result_rows"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.count_result_rows">[docs]</a>    <span class="k">def</span> <span class="nf">count_result_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of result rows in this Statement&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> 
                   <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Statement.get_link"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_link">[docs]</a>    <span class="k">def</span> <span class="nf">get_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the statement&#39;s link, which specifies where the next message </span>
<span class="sd">        in the workflow should be sent to or retrieved from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span>
</div>
<div class="viewcode-block" id="Statement.set_link"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_link">[docs]</a>    <span class="k">def</span> <span class="nf">set_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the statement&#39;s link&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="n">link</span>
</div>
<div class="viewcode-block" id="Statement.get_label"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.get_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the statement&#39;s label&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="Statement.when"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.when">[docs]</a>    <span class="k">def</span> <span class="nf">when</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the statement&#39;s temporal scope&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span>
</div>
<div class="viewcode-block" id="Statement.set_when"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.set_when">[docs]</a>    <span class="k">def</span> <span class="nf">set_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the statement&#39;s temporal scope. Ensures that the temporal scope is</span>
<span class="sd">        within the previous temporal scope unless force is True.</span>
<span class="sd">        Takes either an instance of</span>
<span class="sd">        mplane.model.When, or a string describing the scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> \
           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">when</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot set temporal scope &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">when</span><span class="p">)</span><span class="o">+</span>
                             <span class="s">&quot; within &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">when</span>
</div>
    <span class="k">def</span> <span class="nf">_schema_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a hex string uniquely identifying the set of parameters</span>
<span class="sd">        and result columns (the schema) of this statement.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sstr</span> <span class="o">=</span> <span class="s">&quot;p &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">sstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

    <span class="k">def</span> <span class="nf">_pv_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a hex string uniquely identifying the set of parameters,</span>
<span class="sd">        temporal scope, parameter values, and result columns </span>
<span class="sd">        of this statement. Used as a specification key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">spv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">+</span> <span class="s">&quot; w &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span> <span class="o">+</span>\
               <span class="s">&quot; pk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; pv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">tstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

    <span class="k">def</span> <span class="nf">_mpcv_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a hex string uniquely identifying the set of parameters,</span>
<span class="sd">        temporal scope, parameter constraints, parameter values, metadata, metadata values, </span>
<span class="sd">        and result columns (the extended specification) of this statement.</span>
<span class="sd">        Used as a complete token for statements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">spc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">_constraint</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">spv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">spk</span><span class="p">]</span>
        <span class="n">smk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">smv</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">smk</span><span class="p">]</span>
        <span class="n">tstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">+</span> <span class="s">&quot; w &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span> <span class="o">+</span>\
               <span class="s">&quot; pk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; pc &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; pv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; mk &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">smk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; mv &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">smv</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s">&quot; r &quot;</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">hstr</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">tstr</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hstr</span>

    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span><span class="p">[:</span><span class="n">lim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

    <span class="k">def</span> <span class="nf">_default_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mpcv_hash</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_result_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valstr</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">_prim</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="n">row_index</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">valstr</span> <span class="o">=</span> <span class="n">VALUE_NONE</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valstr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span>

<div class="viewcode-block" id="Statement.to_dict"><a class="viewcode-back" href="../../index.html#mplane.model.Statement.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a Statement to a dictionary (for further conversion </span>
<span class="sd">        to JSON or YAML), which can be passed as the dictval</span>
<span class="sd">        argument of the appropriate statement constructor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">d</span><span class="p">[</span><span class="n">KEY_LINK</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_link</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

        <span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_PARAMETERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_as_tuple</span><span class="p">()</span> 
                                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_METADATA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_as_tuple</span><span class="p">()</span> 
                                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_rows</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">d</span>
</div>
    <span class="k">def</span> <span class="nf">_params_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in parameters from a dictionary; used internally.</span>
<span class="sd">        The default implementation interprets dictionary values</span>
<span class="sd">        as parameter values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in this Statement with values from a dictionary</span>
<span class="sd">        produced with to_dict (i.e., as taken from JSON or YAML).</span>
<span class="sd">        Ignores result values, as these are handled by :func:`Result._from_dict()`; </span>
<span class="sd">        ignores the schedule section, as this is handled in :func:`Specification._from_dict()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">KEY_LABEL</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_LABEL</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_LINK</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_link</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_LINK</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_TOKEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_TOKEN</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">KEY_WHEN</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">When</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_WHEN</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">KEY_PARAMETERS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_PARAMETERS</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">KEY_METADATA</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_METADATA</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KEY_RESULTS</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTS</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_result_column</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clear_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">_clear_constraint</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Capability"><a class="viewcode-back" href="../../index.html#mplane.model.Capability">[docs]</a><span class="k">class</span> <span class="nc">Capability</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Capability represents something an mPlane component can do.</span>
<span class="sd">    Capabilities contain verbs (strings identifying the thing the</span>
<span class="sd">    component can do), parameters (which must be given by a client</span>
<span class="sd">    in a Specification in order for the component to do that thing),</span>
<span class="sd">    metadata (additional information about the process used to do</span>
<span class="sd">    that thing), and result columns (the data that thing will return).</span>

<span class="sd">    Capabilities can either be created programatically, using the</span>
<span class="sd">    add_parameter(), add_metadata(), and add_result_column()</span>
<span class="sd">    methods, or by reading from a JSON or YAML object [FIXME document</span>
<span class="sd">    how this works once it&#39;s written]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p/m/r &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_CAPABILITY</span>

<div class="viewcode-block" id="Capability.set_when"><a class="viewcode-back" href="../../index.html#mplane.model.Capability.set_when">[docs]</a>    <span class="k">def</span> <span class="nf">set_when</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;By default, changes to capability temporal scopes are always forced.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_when</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__or__</span><span class="p">,</span> 
                                <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pval</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Capabilities must have neither parameter nor &quot;</span><span class="o">+</span>
                             <span class="s">&quot;result values.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_params_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in parameters from a dictionary; used internally.</span>
<span class="sd">        The Capability implementation interprets dictionary values</span>
<span class="sd">        as constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Specification"><a class="viewcode-back" href="../../index.html#mplane.model.Specification">[docs]</a><span class="k">class</span> <span class="nc">Specification</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Specification represents a request for an mPlane component to do </span>
<span class="sd">    something it has advertised in a Capability.  </span>
<span class="sd">    Capabilities contain verbs (strings identifying the thing the</span>
<span class="sd">    component can do), parameters (which must be given by a client</span>
<span class="sd">    in a Specification in order for the component to do that thing),</span>
<span class="sd">    metadata (additional information about the process used to do</span>
<span class="sd">    that thing), and result columns (the data that thing will return). </span>

<span class="sd">    Specifications are created either by passing a Capability the</span>
<span class="sd">    Specification is intended to use as the capability= argument of</span>
<span class="sd">    the constructor, or by reading from a JSON or YAML object </span>
<span class="sd">    [FIXME document how this works once it&#39;s written]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capability</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># No dictionary, fill in schedule</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="o">=</span> <span class="n">schedule</span>

            <span class="k">if</span> <span class="n">capability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Build a statement from a capabilitiy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_verb</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_label</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_metadata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>

                <span class="c"># inherit from capability only when necessary</span>
                <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_when</span>

    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p(v)/m/r &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameter_values</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;)/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_SPECIFICATION</span>

    <span class="k">def</span> <span class="nf">fulfills</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capability</span><span class="p">):</span>
        <span class="c"># verify that the schema hash is equal </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">()</span> <span class="o">!=</span> <span class="n">capability</span><span class="o">.</span><span class="n">_schema_hash</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Verify that the specification is within the capability&#39;s temporal scope</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">follows</span><span class="p">(</span><span class="n">capability</span><span class="o">.</span><span class="n">when</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Works for me.</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="Specification.validate"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that this is a valid Specification; i.e., that all parameters have values.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span> 
                        <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Specifications must have parameter values.&quot;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_default_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pv_hash</span><span class="p">()</span>

<div class="viewcode-block" id="Specification.set_single_values"><a class="viewcode-back" href="../../index.html#mplane.model.Specification.set_single_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_single_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fill in values for all parameters whose constraints allow only one value.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">param</span><span class="o">.</span><span class="n">set_single_value</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">has_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">KEY_SCHEDULE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">KEY_SCHEDULE</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="o">=</span> <span class="n">Schedule</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_SCHEDULE</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Result"><a class="viewcode-back" href="../../index.html#mplane.model.Result">[docs]</a><span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;docstring for Result: note the token is generally inherited from the specification&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="n">when</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">specification</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_label</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_label</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">specification</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">specification</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
            <span class="c"># assign token from specification</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
            <span class="c"># allow parameters to take values other than constrained</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_constraints</span><span class="p">()</span>
            <span class="c"># inherit from specification only when necessary</span>
            <span class="k">if</span> <span class="n">when</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">specification</span><span class="o">.</span><span class="n">_when</span>


    <span class="k">def</span> <span class="nf">_more_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; p/m/r(r) &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_metadata</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_columns</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;(&quot;</span><span class="o">+</span>\
               <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_result_rows</span><span class="p">())</span><span class="o">+</span><span class="s">&quot;)&quot;</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_RESULT</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">__and__</span><span class="p">,</span> 
                        <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">has_value</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                        <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pval</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Results must have parameter values.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when</span><span class="o">.</span><span class="n">is_definite</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Results must have definite temporal scope.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in this Result with values from a dictionary</span>
<span class="sd">        produced with to_dict().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">column_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">KEY_RESULTVALUES</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">KEY_RESULTVALUES</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">column_key</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">set_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">row_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">[</span><span class="n">elem_name</span><span class="p">][</span><span class="n">row_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<span class="c">#######################################################################</span>
<span class="c"># Notifications</span>
<span class="c">#######################################################################</span>
</div>
<div class="viewcode-block" id="BareNotification"><a class="viewcode-back" href="../../index.html#mplane.model.BareNotification">[docs]</a><span class="k">class</span> <span class="nc">BareNotification</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notifications are used to send additional information between</span>
<span class="sd">    mPlane clients and components other than measurement statements.</span>
<span class="sd">    Notifications can either be part of a normal measurement workflow</span>
<span class="sd">    (as Receipts and Redemptions) or signal exceptional conditions</span>
<span class="sd">    (as Withdrawals and Interrupts).</span>

<span class="sd">    This class contains implementation common to all Notifications</span>
<span class="sd">    which do not contain any information from a related Capability</span>
<span class="sd">    or Specification.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dictval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span>
</div>
<div class="viewcode-block" id="Exception"><a class="viewcode-back" href="../../index.html#mplane.model.Exception">[docs]</a><span class="k">class</span> <span class="nc">Exception</span><span class="p">(</span><span class="n">BareNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Component sends an Exception to a Client, or a Client to a </span>
<span class="sd">    Component, to present a human-readable message about a failure</span>
<span class="sd">    or non-nominal condition </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errmsg</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Unspecified exception&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span> <span class="o">=</span> <span class="n">errmsg</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;Exception: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KIND_EXCEPTION</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span>
        <span class="n">d</span><span class="p">[</span><span class="n">KEY_MESSAGE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KIND_EXCEPTION</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errmsg</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">KEY_MESSAGE</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="StatementNotification"><a class="viewcode-back" href="../../index.html#mplane.model.StatementNotification">[docs]</a><span class="k">class</span> <span class="nc">StatementNotification</span><span class="p">(</span><span class="n">Statement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common implementation superclass for notifications that </span>
<span class="sd">    may contain all or part of a related Capability or Specification.</span>

<span class="sd">    Clients and components should use :class:`mplane.model.Receipt`,</span>
<span class="sd">    :class:`mplane.model.Redemption`, and :class:`mplane.model.Withdrawal`</span>
<span class="sd">    directly</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">VERB_MEASURE</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dictval</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">statement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verb</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_verb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_when</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resultcolumns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">statement</span><span class="o">.</span><span class="n">_resultcolumns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">kind_str</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_repr</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">token_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sk</span> <span class="ow">in</span> <span class="p">(</span><span class="n">KEY_PARAMETERS</span><span class="p">,</span> <span class="n">KEY_METADATA</span><span class="p">,</span> <span class="n">KEY_RESULTS</span><span class="p">,</span> <span class="n">KEY_LINK</span><span class="p">,</span> <span class="n">KEY_WHEN</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">sk</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Cannot instantiate a raw StatementNotification&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Receipt"><a class="viewcode-back" href="../../index.html#mplane.model.Receipt">[docs]</a><span class="k">class</span> <span class="nc">Receipt</span><span class="p">(</span><span class="n">StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A component presents a receipt to a Client in lieu of a result, when the</span>
<span class="sd">    result will not be available in a reasonable amount of time; or to confirm</span>
<span class="sd">    a Specification &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_RECEIPT</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Redemption"><a class="viewcode-back" href="../../index.html#mplane.model.Redemption">[docs]</a><span class="k">class</span> <span class="nc">Redemption</span><span class="p">(</span><span class="n">StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A client presents a Redemption to a component from which it has received</span>
<span class="sd">    a Receipt in order to get the associated Result.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">receipt</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">receipt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">receipt</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_REDEMPTION</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Withdrawal"><a class="viewcode-back" href="../../index.html#mplane.model.Withdrawal">[docs]</a><span class="k">class</span> <span class="nc">Withdrawal</span><span class="p">(</span><span class="n">StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Withdrawal cancels a Capability&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">capability</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">capability</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_WITHDRAWAL</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Capability</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Interrupt"><a class="viewcode-back" href="../../index.html#mplane.model.Interrupt">[docs]</a><span class="k">class</span> <span class="nc">Interrupt</span><span class="p">(</span><span class="n">StatementNotification</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Interrupt cancels a Specification&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">specification</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">dictval</span><span class="o">=</span><span class="n">dictval</span><span class="p">,</span> <span class="n">statement</span><span class="o">=</span><span class="n">specification</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kind_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">KIND_INTERRUPT</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Specification</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="message_from_dict"><a class="viewcode-back" href="../../index.html#mplane.model.message_from_dict">[docs]</a><span class="k">def</span> <span class="nf">message_from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dictionary returned from to_dict(), return a decoded</span>
<span class="sd">    mPlane message (statement or notification).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">classmap</span> <span class="o">=</span> <span class="p">{</span> <span class="n">KIND_CAPABILITY</span> <span class="p">:</span> <span class="n">Capability</span><span class="p">,</span>
                 <span class="n">KIND_SPECIFICATION</span> <span class="p">:</span> <span class="n">Specification</span><span class="p">,</span>
                 <span class="n">KIND_RESULT</span> <span class="p">:</span> <span class="n">Result</span><span class="p">,</span>
                 <span class="n">KIND_RECEIPT</span> <span class="p">:</span> <span class="n">Receipt</span><span class="p">,</span>
                 <span class="n">KIND_REDEMPTION</span> <span class="p">:</span> <span class="n">Redemption</span><span class="p">,</span>
                 <span class="n">KIND_WITHDRAWAL</span> <span class="p">:</span> <span class="n">Withdrawal</span><span class="p">,</span>
                 <span class="n">KIND_INTERRUPT</span> <span class="p">:</span> <span class="n">Interrupt</span><span class="p">,</span>
                 <span class="n">KIND_EXCEPTION</span> <span class="p">:</span> <span class="ne">Exception</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">classmap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">classmap</span><span class="p">[</span><span class="n">k</span><span class="p">](</span><span class="n">dictval</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Cannot determine message type from &quot;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
</div>
<span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="n">jstr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">message_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jstr</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">unparse_json</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> 
                      <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;: &#39;</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">parse_yaml</span><span class="p">(</span><span class="n">ystr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mplane</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">message_from_dict</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ystr</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">unparse_yaml</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()),</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, Brian Trammell.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>